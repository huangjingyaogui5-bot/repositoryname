<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>エッジポーカー・プロタイマー</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/tesseract.js@v4.0.1/dist/tesseract.min.js"></script>
    <style>
        .heart { font-size: 2.5rem; transition: all 0.3s; position: relative; display: inline-block; }
        .heart-empty { color: #334155; }
        .heart-filled { color: #ef4444; position: absolute; top: 0; left: 0; overflow: hidden; width: 0%; }
    </style>
</head>
<body class="bg-slate-900 text-white p-5">

    <div class="max-w-md mx-auto bg-slate-800 rounded-3xl p-6 border border-slate-700 shadow-2xl">
        <h1 class="text-xl font-bold text-center mb-6 text-blue-400">スタミナ通知 PRO</h1>

        <div class="flex justify-between mb-8 px-2">
            <div class="heart"><span class="heart-empty">♥</span><span class="heart-filled" id="f1">♥</span></div>
            <div class="heart"><span class="heart-empty">♥</span><span class="heart-filled" id="f2">♥</span></div>
            <div class="heart"><span class="heart-empty">♥</span><span class="heart-filled" id="f3">♥</span></div>
            <div class="heart"><span class="heart-empty">♥</span><span class="heart-filled" id="f4">♥</span></div>
            <div class="heart"><span class="heart-empty">♥</span><span class="heart-filled" id="f5">♥</span></div>
        </div>

        <div class="bg-slate-900/50 p-6 rounded-2xl mb-6">
            <input type="range" id="staminaSlider" min="0" max="20" value="0" step="1" 
                   class="w-full h-3 bg-slate-700 rounded-lg appearance-none cursor-pointer accent-red-500"
                   oninput="updateUI(this.value)">
            <p id="statusLabel" class="text-center mt-4 font-bold text-red-400 text-xl">現在: 0.00 個</p>
        </div>

        <button onclick="startTimer()" class="w-full bg-red-600 hover:bg-red-500 py-4 rounded-2xl font-bold text-lg shadow-lg mb-6 transition">
            通知を予約する
        </button>

        <details class="text-slate-500 text-sm bg-slate-900/80 rounded-xl p-2">
            <summary class="cursor-pointer text-center py-2">📸 スクショから誤差を自動入力</summary>
            <div class="mt-4 p-2 space-y-4">
                <p class="text-[10px]">スタミナ付近のスクショを選択してください。<br>残り時間を解析して「次の1/4」までの時間を補正します。</p>
                <input type="file" id="upload" accept="image/*" class="w-full text-xs">
                <div id="ocrStatus" class="text-blue-400 text-xs text-center"></div>
                <div class="flex gap-2 items-center justify-center">
                    <span class="text-xs">補正値:</span>
                    <input type="number" id="manualMin" value="60" class="w-20 bg-slate-700 p-1 rounded text-white text-center text-lg">
                    <span>分</span>
                </div>
            </div>
        </details>

        <div id="schedule" class="mt-6 space-y-2 text-sm text-slate-400 font-mono"></div>
    </div>

    <script>
        const MIN_PER_STEP = 60; // 1時間(1/4回復)

        function updateUI(val) {
            for (let i = 1; i <= 5; i++) {
                const filled = document.getElementById(`f${i}`);
                const heartLevel = Math.max(0, Math.min(4, val - (i - 1) * 4));
                filled.style.width = (heartLevel * 25) + "%";
            }
            document.getElementById('statusLabel').innerText = `現在: ${(val / 4).toFixed(2)} 個`;
        }

        // --- 画像解析ロジック ---
        document.getElementById('upload').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            const status = document.getElementById('ocrStatus');
            status.innerText = "解析中...";

            const worker = await Tesseract.createWorker('eng');
            await worker.setParameters({ tessedit_char_whitelist: '0123456789:' });
            
            const { data: { text } } = await worker.recognize(file);
            console.log("読み取り:", text);

            // "分" を抽出する簡易ロジック (例 35:20 -> 35分)
            const timeMatch = text.match(/(\d{1,2}):\d{2}/);
            if (timeMatch) {
                const mins = parseInt(timeMatch[1]);
                document.getElementById('manualMin').value = mins + 1; // 秒切り上げ
                status.innerText = `成功: 次まであと ${mins} 分`;
            } else {
                status.innerText = "時間を読み取れませんでした。手入力してください。";
            }
            await worker.terminate();
        });

        // --- タイマーセット ---
        function startTimer() {
            const currentSteps = parseInt(document.getElementById('staminaSlider').value);
            if (!("Notification" in window)) return alert("通知非対応です");

            Notification.requestPermission().then(permission => {
                if (permission !== "granted") return alert("通知を許可してください");

                const scheduleDiv = document.getElementById('schedule');
                scheduleDiv.innerHTML = "";

                const firstWait = parseInt(document.getElementById('manualMin').value) || MIN_PER_STEP;
                const targets = [4, 12, 20]; // 1個、3個、5個(MAX)

                targets.forEach(target => {
                    if (target > currentSteps) {
                        const diffSteps = target - currentSteps;
                        const waitMin = firstWait + ((diffSteps - 1) * MIN_PER_STEP);
                        
                        const time = new Date(Date.now() + waitMin * 60000);
                        const timeStr = time.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});

                        let msg = `ハートが ${target/4} 個になりました！`;
                        if (target === 20) msg = "全回復(MAX)しました！";

                        setTimeout(() => {
                            new Notification("エッジポーカー", { body: msg });
                        }, waitMin * 60000);

                        scheduleDiv.innerHTML += `
                            <div class="flex justify-between border-b border-slate-700 py-1 px-2">
                                <span>${target/4}個目</span> <span>${timeStr}</span>
                            </div>`;
                    }
                });
                alert("通知を予約しました！ブラウザを開いたままにしておいてください。");
            });
        }
    </script>
</body>
</html>